generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// role management
enum RoleType{
  SYSTEM_ADMIN     // Quản trị viên hệ thống
  SELLER       
  CUSTOMER 
  GUEST        
  KYC_REVIEWER     // Người duyệt KYC
}

model Role{
  id          String   @id @default(uuid())
  name        String   @unique
  type        RoleType
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by")
  updatedBy   String?    @map("updated_by")
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by")

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
  @@index([type])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
}

enum PermissionModule {
  USER_MANAGEMENT
  SHOP_MANAGEMENT
  PRODUCT_MANAGEMENT
  ORDER_MANAGEMENT
  KYC_MANAGEMENT
  CATEGORY_MANAGEMENT
  SYSTEM_SETTINGS
  REPORTS_ANALYTICS
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  REJECT
  EXPORT
  IMPORT
  ASSIGN
  REVOKE
}

model Permission {
  id          String           @id @default(uuid())
  module      PermissionModule
  action      PermissionAction
  description String?
  isActive    Boolean          @default(true) @map("is_active")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by")
  updatedBy   String?    @map("updated_by")
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by")

  // Relations
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@unique([module, action])
  @@map("permissions")
  @@index([module])
  @@index([action])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by")
  updatedBy   String?    @map("updated_by")
  
  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
  @@index([roleId])
  @@index([permissionId])
  @@index([createdAt])
}

model UserRole {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  roleId    String        @map("role_id")
  isActive  Boolean       @default(true) @map("is_active")
  expiresAt DateTime?     @map("expires_at") // Role có thể có thời hạn
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by")
  updatedBy   String?    @map("updated_by")
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
  @@index([userId])
  @@index([roleId])
  @@index([isActive])
  @@index([expiresAt])
  @@index([createdAt])
}

model UserPermission {
  id           String  @id @default(uuid())
  userId       String  @map("user_id")
  permissionId String  @map("permission_id")
  isGranted    Boolean @default(true) @map("is_granted") // true = grant, false = deny
  expiresAt    DateTime? @map("expires_at")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by")
  updatedBy   String?    @map("updated_by")
  
  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("user_permissions")
  @@index([userId])
  @@index([permissionId])
  @@index([isGranted])
  @@index([expiresAt])
  @@index([createdAt])
}

model UserActivity {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  action      String   // CREATE_PRODUCT, UPDATE_SHOP, DELETE_USER, etc.
  module      String   // PRODUCT, SHOP, USER, etc.
  resourceId  String?  @map("resource_id") // ID của tài nguyên bị tác động
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  metadata    Json?    // Thông tin bổ sung
  performedAt DateTime @default(now()) @map("performed_at")
  
  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_activities")
  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([resourceId])
  @@index([performedAt])
}

// User management
enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
  BANNED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

model User {
  // Primary fields
  id          String     @id @default(uuid())
  email       String     @unique
  password    String
  identityCard String?    @unique
  
  // Personal information
  firstName   String     @map("first_name")
  lastName    String     @map("last_name")
  phoneNumber String?    @map("phone_number") @unique
  address     String?
  birthday    DateTime?
  gender      Gender?
  avatarUrl   String?    @map("avatar_url")
  
  // Status and verification
  status        UserStatus @default(PENDING)
  emailVerified Boolean    @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  
  // Security fields
  lastLoginAt   DateTime? @map("last_login_at")
  passwordResetToken String? @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by")
  updatedBy   String?    @map("updated_by")
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by")

  // relation
  shop Shop? @relation("ShopOwner")
  approvedShops Shop[]     @relation("ShopApprover") 
  reviewedKycs  KycData[]  @relation("KycReviewer")
  kycData       KycData[]
  roles     UserRole[]
  permissions UserPermission[]
  activities    UserActivity[]

  @@map("users")
  @@index([email])
  @@index([status])
  @@index([emailVerified])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([phoneNumber])
  @@index([firstName, lastName])
}

enum KycStatus{
  INCOMPLETE
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum DocumentType{
  IDENTITY_CARD
}

enum DocumentStatus{
  PENDING
  VERIFIED
  REJECTED
}

// Shop Management
enum ShopStatus {
  DRAFT
  ACTIVE
  INACTIVE
  SUSPENDED
  CLOSED
}

enum ApprovalStatus {
  PENDING_APPROVAL
  PENDING_KYC
  APPROVED
  REJECTED
  REVIEWING
  REQUIRES_DOCUMENTS
}

model Shop {
  // Primary fields
  id      String     @id @default(uuid())
  ownerId String     @map("owner_id") @unique
  name    String     @unique
  status  ShopStatus @default(INACTIVE)
  logoUrl         String?        @map("logo_url")
  email   String?    @map("email") @unique
  phoneNumber String? @map("phone_number") @unique
  
  // Address fields 
  street      String?
  ward        String?
  district       String?
  city  String?  
  country     String @default("Việt Nam")

  // Business config
  category    String? // bán gì ? Quần áo, giày dép, công nghệ...
  isVerified      Boolean        @default(false) @map("is_verified") // giống shopee mall á
  verifiedAt      DateTime?      @map("verified_at")

  //operation
  autoApprove     Boolean        @default(false) @map("auto_approve") // tu xac nhan don hang
  
  // Approval
  approvalStatus  ApprovalStatus @default(PENDING_APPROVAL) @map("approval_status")
  approvedBy      String?        @map("approved_by")
  approvedAt      DateTime?      @map("approved_at")
  rejectionReason String?        @map("rejection_reason")

  // bank
  bankName        String?        @map("bank_name")
  bankAccount     String?        @map("bank_account")
  bankAccountNumber String?      @map("bank_account_number")

  // statistic
  totalRevenue    Decimal        @default(0) @map("total_revenue") @db.Decimal(15,2)
  totalOrders     Int            @default(0) @map("total_orders")
  rating          Decimal?       @db.Decimal(3,2) // trung bình từ sp trong shop
  reviewCount     Int            @default(0) @map("review_count")

  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") 
  updatedBy   String?    @map("updated_by") 
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") 

  approver        User?          @relation("ShopApprover", fields: [approvedBy], references: [id])
  
  currentKycId    String?        @unique @map("current_kyc_id")
  currentKyc      KycData?       @relation("CurrentKyc", fields: [currentKycId], references: [id])

  // Relations
  owner    User       @relation("ShopOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  products Product[] // 1 shop có nhiều products
  kycData  KycData[]  @relation("ShopKyc")
  
  @@map("shops")
  @@unique([bankName, bankAccountNumber])
  @@index([ownerId])
  @@index([status])
  @@index([name])
  @@index([city])
  @@index([createdAt])
  @@index([deletedAt])
}

model KycData{
  id                String    @id @default(uuid())
  status            KycStatus @default(INCOMPLETE)
  submittedAt       DateTime?
  reviewedAt        DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  reviewerNote      String?
  expiryDate        DateTime? // Ngày hết hạn KYC

  // nguoi gui
  fullName          String?
  birthday          DateTime?
  personalAddress   String?
  personalPhone     String?
  personalEmail     String?
  identityCard      String? // Số CMND/CCCD

  // shop
  shopName      String?
  taxCode       String?
  shopAddress   String?
  shopPhone     String?
  shopEmail     String?
  shopRegDate   DateTime? // Ngày đăng ký kinh doanh

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  shopId String

  user      User          @relation(fields: [userId], references: [id])
  shop      Shop          @relation("ShopKyc", fields: [shopId], references: [id])
  currentShop Shop?       @relation("CurrentKyc")
  reviewerUserId String?   @map("reviewer_user_id")
  reviewer       User?     @relation("KycReviewer", fields: [reviewerUserId], references: [id])
  documents KycDocument[]
  history   KycHistory[]

  @@unique([shopId])
  @@map("kyc_data")
}

model KycDocument{
  id           String         @id @default(uuid())
  type         DocumentType
  status       DocumentStatus @default(PENDING)
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime       @default(now())
  verifiedAt   DateTime?
  rejectedAt   DateTime?
  verifierNote String?        // Ghi chú của người xác minh
  
  // Foreign key
  kycDataId String

  // Relations
  kycData KycData @relation(fields: [kycDataId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

model KycHistory {
  id          String    @id @default(uuid())
  action      String    // CREATE, UPDATE, APPROVE, REJECT, etc.
  oldStatus   KycStatus?
  newStatus   KycStatus?
  reason      String?
  performedBy String?   // ID của người thực hiện
  performedAt DateTime  @default(now())
  metadata    Json?     // Thông tin bổ sung dạng JSON

  kycDataId String

  kycData KycData @relation(fields: [kycDataId], references: [id], onDelete: Cascade)

  @@map("kyc_history")
}

model KycSettings {
  id                    String   @id @default(uuid())
  requiredDocuments     String[] // Array of DocumentType
  kycExpiryDays        Int      @default(365) // KYC hết hạn sau bao nhiêu ngày
  autoApprovalEnabled  Boolean  @default(false)
  maxFileSize          Int      @default(10485760) // 10MB in bytes
  allowedMimeTypes     String[] // ["image/jpeg", "image/png", "application/pdf"]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("kyc_settings")
}

// Product Management
enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  OUT_OF_STOCK
  DISCONTINUED
}

model Product {
  // Primary fields
  id            String        @id @default(uuid())
  shopId        String        @map("shop_id")
  name          String
  averageRating Float         @default(0) @map("average_rating")
  reviewCount   Int           @default(0) @map("review_count")
  status        ProductStatus @default(DRAFT)
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Product relations
  shop     Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  variants ProductVariant[]
  images   ProductImage[]
  options  ProductOption[]
  categories ProductCategory[]
  
  @@map("products")
  @@index([shopId])
  @@index([status])
  @@index([name])
  @@index([averageRating])
  @@index([createdAt])
  @@index([deletedAt])
}

model ProductVariant {
  // Primary fields
  id          String        @id @default(uuid())
  productId   String        @map("product_id")
  sku         String        @unique
  name        String
  value       String
  price       Decimal       @db.Decimal(10, 2)
  currency    String        @default("VND") // For Money value object
  status      ProductStatus @map("product_status") @default(DRAFT)
  description String?
  stock       Int           @default(0) 
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Product variant relations
  product      Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  images       ProductImage[]
  optionValues ProductVariantOptionValue[]
  
  @@map("product_variants")
  @@index([productId])
  @@index([sku])
  @@index([status])
  @@index([price])
  @@index([createdAt])
  @@index([deletedAt])
}

model ProductImage {
  // Primary fields
  id          String  @id @default(uuid())
  productId   String  @map("product_id")
  variantId   String? @map("variant_id")
  imageUrl    String  @map("image_url")
  isPrimary   Boolean @default(false) @map("is_primary")
  sortOrder   Int     @default(0) @map("sort_order")
  description String?
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Product image relations
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@map("product_images")
  @@index([productId])
  @@index([variantId])
  @@index([isPrimary])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([deletedAt])
}

model ProductOption {
  // Primary fields
  id        String @id @default(uuid())
  productId String @map("product_id")
  name      String @db.Citext
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Product option relations
  product                   Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  values                    ProductOptionValue[]
  productVariantOptionValues ProductVariantOptionValue[]
  
  @@unique([productId, name])
  @@map("product_options")
  @@index([productId])
  @@index([name])
  @@index([createdAt])
  @@index([deletedAt])
}

model ProductOptionValue {
  // Primary fields
  id              String @id @default(uuid())
  productOptionId String @map("product_option_id")
  value           String @db.Citext
  sortOrder       Int    @default(0) @map("sort_order")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Product option value relations
  productOption              ProductOption               @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  productVariantOptionValues ProductVariantOptionValue[]
  
  @@unique([productOptionId, value])
  @@map("product_option_values")
  @@index([productOptionId])
  @@index([sortOrder])
  @@index([value])
  @@index([createdAt])
  @@index([deletedAt])
}

model ProductVariantOptionValue {
  // Primary fields
  id                   String @id @default(uuid())
  productVariantId     String @map("product_variant_id")
  productOptionId      String @map("product_option_id")
  productOptionValueId String @map("product_option_value_id")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Many-to-many relation fields
  productVariant     ProductVariant     @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productOption      ProductOption      @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  productOptionValue ProductOptionValue @relation(fields: [productOptionValueId], references: [id], onDelete: Cascade)
  
  @@map("product_variant_option_values")
  @@unique([productVariantId, productOptionId])
  @@index([productVariantId])
  @@index([productOptionId])
  @@index([productOptionValueId])
  @@index([createdAt])
  @@index([deletedAt])
}

// Category Management
model Category {
  // Primary fields
  id               String  @id @default(uuid())
  name             String
  description      String  @default("")
  parentCategoryId String? @map("parent_category_id")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Self-referencing relations
  parentCategory Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories Category[] @relation("CategoryHierarchy")
  
  // Many-to-many relation with products
  products ProductCategory[]
  
  @@map("categories")
  @@index([name])
  @@index([parentCategoryId])
  @@index([createdAt])
  @@index([deletedAt])
}

// many to many product and category
model ProductCategory {
  // Primary fields
  id         String @id @default(uuid())
  productId  String @map("product_id")
  categoryId String @map("category_id")
  
  // Auditable fields
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String?    @map("created_by") // User ID who created
  updatedBy   String?    @map("updated_by") // User ID who last updated
  
  // Soft delete fields
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by") // User ID who deleted
  
  // Relations
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@map("product_categories")
  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([deletedAt])
}